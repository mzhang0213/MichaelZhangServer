<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <link href='https://fonts.googleapis.com/css?family=Cabin' rel='stylesheet'>
  </head>
  <body>
    <font style="font-family: 'Cabin';">
      <center>
        <p style="font-size:60px;margin:0;margin-top:20px;padding:0;">Notifications</p>
      </center>
      <br><br>
      <p id="loadingBox">Fetching...</p>
      
      <div id="items"></div> <!--append here-->

      <!-- sample poggers
      <div class="itemContainer">
        <div class="icon"></div>
        <div class="text">
          <p class="title" readonly>This is my title.</p>  remember these p tags are display block
          <p class="description" readonly>COMPLETE THE ASSIGNMENT DUMBASS</p>
        </div>
      </div>
      -->

      <div id="bottomZone">
        <div id="popupDock">
          <button id="refresh" class="taskbarButton" title="Refresh">üîÅ</button>
          <div id="skipControls">
            <button id="prev" class="taskbarButton" title="Previous 50">‚óÄ</button>
            <button id="next" class="taskbarButton" title="Next 50">‚ñ∂</button>
          </div>
        </div>
        <div id="upIconContainer">
          <p id="upIcon">üîº</p>
        </div>
      </div>
    </font>
    <style>
      .taskbarButton{
        width:55px;
        height:55px;
        font-size:30px;
      }
      .itemContainer{
        border: 1px solid #000000;
        display:flex;
        align-items:center;
        width:500px;
        height:100px;
        position:relative;
        border-radius:15px;
        margin:0 auto;
      }
      .icon, .text {
        position:relative;
      }
      .icon{
        width:50px;
        height:50px;
        display:flex;
        align-items:center;
        justify-content:center;
      }
      .text{
        width:500px;
        height:100px;
        display:flex;
        flex-direction:column;
        justify-content:center;
      }
      .title,.description,.stats{
        padding:0;
        margin:0;
        left:10px;
        width:445px;
        border:none;
        resize:none;
        position:relative;

        overflow:hidden;
        white-space:nowrap;
        text-overflow:ellipsis;
        display:block;
      }
      .title{
        font-size:30px;
        margin-top:20px;
      }
      .description{
        opacity:50%;
      }
      #bottomZone{
        position:fixed;
        left:0;
        top:0;
        height:70px;
      }
      #skipControls{
        display:flex;
        align-items:center;
        justify-content:space-evenly;
      }
      #popupDock{
        position:absolute;
        height:70px;
        border: 4px black solid;
        display:flex;
        align-items:center;
        justify-content:space-evenly;
      }
      #upIcon{
        position:fixed;
        bottom:0;
        margin:0;
        padding:0;
        width:25px;
        height:25px;
      }
      #upIconContainer{
        position:relative;
      }
    </style>
    <script src="https://code.jquery.com/jquery-2.1.0.js"></script>
    <script>
    
      /* ui plan: (assignment = courseWork)
        items have icon, title, desc
        ANNOUNCEMENTS IS JUST ONE TEXT SO NO TITLE AND DELETE THE TITLE BOX ON THESE ONES
        make desc textarea and maybe title?
          remember to turn off border, user box expansion, select on those
            have .mouseover on each item reveal circle three dots button on the top right
        three dots button alt/hover="Details" yellow text thing
            click: expand description, pop out white, reveal grey screen size div w/ z index=1
            have little bubbles floating over the top of that item that show:
        pts value
        date and time due (format: Due MM/DD/YY at HH:MM) IF assignment
        date posted
        materials (like yt videos) IF assignment or courseWorkMaterials
            write a function that creates a text centered vertical horizontal in a small circle bubble
        font-size:15px
        eg var createBubble = function(text,fontSize,location) {} //location = append location
      */
    
      var gebi = function(elem){return document.getElementById(elem)};
      gebi("bottomZone").style.zIndex=10;
      gebi("popupDock").style.bottom=0;
      gebi("bottomZone").style.top=(window.innerHeight-70)+"px";
      gebi("bottomZone").style.width=(window.innerWidth*0.45)+"px";
      gebi("bottomZone").style.left=(window.innerWidth*0.27)+"px";
      gebi("popupDock").style.width=(window.innerWidth*0.45)+"px";
      gebi("skipControls").style.width=(window.innerWidth*0.45/2)+"px";
      gebi("skipControls").style.width=(window.innerWidth*0.45/2)+"px";
      gebi("upIconContainer").style.left=(window.innerWidth*0.45/2)+17+"px";
      
      gebi("popupDock").style.display="none";
      gebi("popupDock").style.backgroundColor="white";
      document.getElementById("bottomZone").addEventListener("mouseenter", ()=>{
        if (!$("#popupDock").is(':animated')){
          $("#popupDock").slideToggle(350);
          document.getElementById("upIcon").style.display="none"
        }
      })
      document.getElementById("bottomZone").addEventListener("mouseleave", ()=>{
        if (!$("#popupDock").is(':animated')){
          $("#popupDock").slideToggle(350);
          setTimeout(()=>document.getElementById("upIcon").style.display="",350)
        }
      })

      const urlParams = new URLSearchParams(window.location.search);
      var httpReq = function(method, url, access_token, cb){
        var req = new XMLHttpRequest();
        req.open(method, url);
        if (access_token!==undefined)req.setRequestHeader("Authorization", "Bearer " + access_token);
        req.send();
        req.onload = function(){
          if (req.readyState === 4){
            cb(JSON.parse(req.responseText), undefined);
          } else {
            cb(undefined, "not ready err")
          }
        }
      }
      var accessToken = urlParams.has("access_token")?urlParams.get("access_token"):undefined;
      
      var totalItems = [];
      var cidTeachers = [];
      var notiPos = 0;
      var getTeacher = function(id){
        for (var i=0;i<cidTeachers.length;i++){
          if (cidTeachers[i][0]===id){
            return cidTeachers[i][1];
          }
        }
        console.log("lonely world: couldn't find teacher")
        return "fuck";
      }
      var createItem = function(itemObj){ //if announcement make title=undefined
        var itemContainer = document.createElement("div");itemContainer.className="itemContainer";
        var icon = document.createElement("div");icon.className="icon";//icons: assignedIcon.png , materialIcon.png , submittedIcon.png, announcementIcon.png
        var text = document.createElement("div");text.className="text";
        var description = document.createElement("p");description.className="description";
        var stats = document.createElement("p");stats.className="stats";
        var blue = document.createElement("font");blue.style.color="#4254f5";
        var green = document.createElement("font");green.style.color="#2dc237";
        var iconImage = document.createElement("img");
        iconImage.style.width=iconImage.style.height="40px";
        
        if(!itemObj.hasOwnProperty("text")){
          //assignment or material
          if (itemObj.hasOwnProperty("dueDate"))iconImage.src="assignedIcon.png";
          else iconImage.src="materialIcon.png";
          var title = document.createElement("p");title.className="title";
          title.append(itemObj.title);
          if (!(itemObj.description===undefined)) description.append(itemObj.description);
		      text.appendChild(title);
        }else{
          //announcement
          iconImage.src="announcementIcon.png";
          if (!(itemObj.text===undefined)) description.append(itemObj.text);
        }
        text.appendChild(description);
        var thisDate = new Date(itemObj.creationTime);
        var date = (thisDate.getMonth()+1)+"/"+thisDate.getDate()+"/"+thisDate.getFullYear();
        blue.append(date);
        green.append(getTeacher(itemObj.courseId));
        stats.appendChild(blue);stats.append("  |  ");stats.appendChild(green);
        text.appendChild(stats);
        icon.appendChild(iconImage);
        itemContainer.appendChild(icon);itemContainer.appendChild(text);
        document.getElementById("items").append(itemContainer);
        document.getElementById("items").appendChild(document.createElement("br"));document.getElementById("items").appendChild(document.createElement("br"));
      }
      
      var displayItems = function(di) {
        document.getElementById("items").innerHTML = "";

        if (di==="left"){

          notiPos-=20;

          if (notiPos<0){
            notiPos=0;
            document.getElementById("prev").disabled=true;
            document.getElementById("next").disabled=false;
            for (var i=notiPos;i<20;i++){
              createItem(totalItems[i]);
            }
            return;
          }

        }else if(di==="right"){

          notiPos+=20;

          if (notiPos>totalItems.length){
            notiPos-=20;
            document.getElementById("prev").disabled=false;
            document.getElementById("next").disabled=true;
            for (var i=notiPos;i<totalItems.length;i++){
              console.log(totalItems[i],totalItems)
              createItem(totalItems[i]);
            }
            return;
          }
        }
        document.getElementById("prev").disabled=false;
        document.getElementById("next").disabled=false;
        for (var i=notiPos;i<20;i++){
          createItem(totalItems[i]);
        }
      }

      var pushGreatestLeast = function(arr, dest){
        for (var j=0;j<arr.length;j++){
          for (var k=0;k<dest.length;k++){
            if (new Date(arr[j].creationTime).getTime()>new Date(dest[k].creationTime).getTime()){
              dest.splice(k,0,arr[j]);break;
            } else if (new Date(arr[j].creationTime).getTime()===new Date(dest[k].creationTime).getTime()) {
              var pos=0;
              (function greaterThan(indox){
                if (arr[j].title.charAt(indox).toUpperCase()>dest[k].title.charAt(indox).toUpperCase){
                  dest.splice(k,0,arr[j]);return;
                } else if(arr[j].title.charAt(indox).toUpperCase()<dest[k].title.charAt(indox).toUpperCase) {
                  dest.splice(k+1,0,arr[j]);return;
                } else {
                  pos++;
                  return greaterThan(pos);
                }
              })(pos);
            } else {
              if (k===dest.length-1){
                dest.splice(k+1,0,arr[j]);
                break;
              }
            }
          }
        }
      }
      
      var doReq = function(){
        httpReq("GET", "https://classroom.googleapis.com/v1/courses", accessToken, (data, err)=>{
          cidTeachers = [];
          notiPos=0;

          (function(){
            var index=0;
            nextStep();
            function nextStep(){
              if (index>=data.courses.length){
                document.getElementById("refresh").addEventListener("click", function(){
                  doReq();
                  document.getElementById("loadingBox").style.display="";
                });
                document.getElementById("prev").addEventListener("click", function(){
                  displayItems("left");
                })
                document.getElementById("next").addEventListener("click", function(){
                  displayItems("right");
                })
                document.getElementById("prev").disabled=true;
                document.getElementById("loadingBox").style.display="none";
                displayItems("right");
                
                return;
              }
              var i=index++;
              var id = data.courses[i].id;
              
              if (data.courses[i].courseState==="ACTIVE"){
                cidTeachers.push( [ data.courses[i].id , data.courses[i].name ] );
                httpReq("GET", "https://classroom.googleapis.com/v1/courses/"+id+"/courseWork", accessToken, (dota, err)=>{
                  if (err) console.log(err);
                  else{
                    if (Object.keys(dota).length!==0){ //sometimes there is no data in object
                      //for loop and sort the push into the loop
                      if (totalItems.length===0){
                        for (var a=0;a<dota.courseWork.length;a++){
                          totalItems.push(dota.courseWork[a]);
                        }
                      }else{
                        pushGreatestLeast(dota.courseWork, totalItems);
                      }
                    }
                    httpReq("GET", "https://classroom.googleapis.com/v1/courses/"+id+"/courseWorkMaterials", accessToken, (deta, err)=>{
                      if (err) console.log(err);
                      else{
                        if (Object.keys(deta).length!==0){
                          //for loop and sort the push into the loop
                          if (totalItems.length===0){
                            for (var b=0;b<deta.courseWorkMaterial.length;b++){
                              totalItems.push(deta.courseWorkMaterial[b]);
                            }
                          }else{
                            pushGreatestLeast(deta.courseWorkMaterial, totalItems);
                          }
                        }
                        httpReq("GET", "https://classroom.googleapis.com/v1/courses/"+id+"/announcements", accessToken, (daeta, err)=>{
                          if (err) console.log(err);
                          else{
                            if (Object.keys(daeta).length!==0){
                              //for loop and sort the push into the loop
                              if (totalItems.length===0){
                                for (var c=0;c<daeta.announcements.length;c++){
                                  totalItems.push(daeta.announcements[c]);
                                }
                              }else{
                                pushGreatestLeast(daeta.announcements, totalItems);
                              }
                            }
                            nextStep();
                          }
                        })
                      }
                    })
                  }
                })
              }else nextStep();
            }
          })();
        })
      }
      doReq();
    </script>
  </body>
</html>