<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <link href='https://fonts.googleapis.com/css?family=Cabin' rel='stylesheet'>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="./logo.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href='https://fonts.googleapis.com/css?family=Merriweather' rel='stylesheet'>
    <script>
      tailwind.config = {
        theme: {
          screens: {
            sm: '0px',
            md: '700px',
            lg: '1200px',
            xl: '1600px'
          }
        }
      }
    </script>
    <script>
      var navMenuShown = false;
      var gebi = function(e){return document.getElementById(e)};
      var resize = function(){
        if (window.innerWidth<700){
          //small
        }else if (700<=window.innerWidth && window.innerWidth<1200){
          //med
        }else{
          //lg++
        }
      }
      window.onresize=resize;
    </script>
    <style>
      html{
        scroll-behavior:smooth;
      }
    </style>
  </head>
  <body onscroll="(function(){if(window.scrollY>10)document.getElementById('navbar').style.backgroundColor='rgba(0,0,0,1)'; else if (window.scrollY<10)document.getElementById('navbar').style.backgroundColor='rgba(0,0,0,0.5)'})()">
    <!--navbar-->
    <nav id="navbar" class="left-0 top-0 z-50 flex items-center justify-between flex-wrap w-screen fixed pr-4 pl-2" style="height:40px; font-family: 'Merriweather';transition: background-color 200ms linear; background-color:rgba(0,0,0,0.5)">
      <div class="flex items-center flex-shrink-0 text-white mr-6 pl-2" onclick="(function(){window.location=window.location.origin})()">
        <button class="text-xl tracking-tight">Music Quiz</span>
      </div>
      <div class="block md:hidden">
        <button id="menuToggle" class="flex items-center px-3 py-2 border rounded text-gray-300 border-gray-300 hover:text-white hover:border-white">
          <svg class="fill-current h-3 w-3" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"/></svg>
        </button>
      </div>
      <div id="navItemContainer" class="w-full block flex-grow md:flex md:items-center md:justify-end md:w-auto text-sm" style="height:100%">
        <div onclick="(function(){window.location=window.location.origin+'/musicQuiz/'})()" class="block mt-4 md:flex md:items-center md:pl-2 md:pr-2 md:mt-0 text-gray-200 hover:text-white" style="height:100%;cursor:pointer;">Home</div>
        <div onclick="(function(){})()" class="block mt-4 md:flex md:items-center md:pl-2 md:pr-2 md:mt-0 text-gray-200 hover:text-white" style="height:100%;cursor:pointer;"><b>1秒 Game</b></div>
        <div onclick="(function(){})()" class="block mt-4 md:flex md:items-center md:pl-2 md:pr-2 md:mt-0 text-gray-200 hover:text-white" style="height:100%;cursor:pointer;"><b>Lyric Game</b></div>
      </div>
    </nav>
    <div class="absolute left-0 top-0 -z-10 bg-cover bg-fixed bg-repeat-y" style="width:100%;height:500vh;background-image:url('./kimi-bg.png')"></div>
    <font style="font-family: 'Cabin';">
    <!--<div id="tabs" class="absolute -z-10 flex flex-row w-9/12 h-fit">
      <div id="osg" class="rounded-xl">1秒</div>
      <div id="lyrics" class="rounded-xl">Lyrics</div>
    </div>-->
    <center>
      <div id="contentBox" class="relative flex flex-col w-9/12 mt-24 rounded-xl justify-center items-center bg-gray-100" style="height:80vh;overflow:auto;">
        <div id="osg" class="relative flex flex-col justify-start items-center p-4" style="width:100%;height:100%">
          <div id="osgStart" style="width:100%">
            <div id="menu1" class="mt-4">
              <p class="font-4xl"><u>Song Guessing</u></p>
              <!--<button id="osgHowToButton" class="main mt-12">How to Play</button>-->
              <button id="osgStartButton1" class="main  relative font-xl mt-4">Choose Playlists >></button>
            </div>
            <div id="menu2" style="display:none">
              <div id="menu2Desc">
                <p class="font-2xl"><b>Choose your playlists</b></p>
                <img id="ytButton" class="mt-4" style="z-index:10;width:35px;">
              </div>
              <div id="ytPlaylists" class="grid grid-cols-5" style="width:100%;display:none;"></div>
              <div id="playlistB" class="grid grid-cols-5" style="width:100%;display:none;"></div>
              <button id="osgStartButton2" class="main fixed font-lg" style="display:none; bottom:10px; right:10px;">Play!</button>
              <button id="osgBackButton2" class="main fixed font-lg" style="display:none; bottom:10px; left:10px;">< Back</button>
            </div>
          </div>
          <!--
            choose either beginning or mid of song
            then hit play
            then do like 20 songs or something chosen
            make it so that buzzers can be on keyboard or just general buzzer AND THEN DROPDOWN picker to give points to person
            i can do play with MC on a live connection to server where they can approve and deny answers and see answers live hehehehe

            todo:
            add youtube and spotify playlist link import
            remove highlightable boxes on the playlists
            maybe add spacing between items in the grid...
            add css styling
              seems like the p len is too small, chg font size
              chg bg color
              curr game highlighted in navbar
            make the box bigger
            add in the liked songs playlist

            put floating stuck next button on the bot right
            put title "one second game"
            put "how to instructions" above the playlists
            some space
            on next, choose settings:
            -lives per player?
            -players
            -time threshold for buzzing after question shown
            -starting duration for music
            -want to play start of music or start of chorus

            if choose start of chorus:
            -need spotify song preview links (should just be in playlist)

            game
            정답:
            a search box?
            big grid with album covers and song titles and search box?
            do a answer box and if artist / title is close enough
              like count # of mistaken characters and see if the mistakes are close to their respective keys on keyboard or something eh that might be too hard

            note that you can buzz whenever, just disable buzzers until round starts
            for each round:
              say 음악 주세요 and then it will be fun
              count down
              auto play music
              500ms
              display question mark / indicator that it is time to buzz
              on buzz: 6 seconds to start typing, +1 if text box len > 0.5(answer len)
            make a buzzer system w/ keyboard and you can bind multiple keys, make sides of the screen light up when some player presses
            also make underlying time limit before question answer window expires
          -->
          <!--
            also make image guessing game
              figure person guessing game

          -->
        </div>
        <div id="lyrics">
          <!--
            serve lyrics using some random ass api and then see if they can get song
            time limit?
            other way to do this game?
          -->
        </div>
      </div>
    </center>
    </font>
    <style>
      /*
      #tabs div{
        height:40px;
        padding-left:7px;
        padding-right:7px;
        padding-top:3px;
        padding-bottom:3px;
        background-color:rgb(243 244 246); //gray-100
        user-select:none;
        margin-right:7px;
      }
      */
      #hearts img{
        width:20px;
      }
      #hearts{
        position:absolute;
        top:5px;
        left:5px;
        display:flex;
        height:fit-content;
        width:fit-content;
        flex-direction: column;
      }
      .main{ /*note: no font size*/
        border-radius:8px;
        border:2px solid #000000;
        font-family:'Cabin';
        outline:none;
        padding:4px;
        margin-bottom:20px; /* NOTE this is gap betw buttons */
      }
      #osgStartButton1{
        background-color:#4eb8ff;
      }
      #osgStartButton1:disabled{
        background-color:#bde5ff;
      }
      #osgStartButton1:hover{
        background-color:#489ed8;
      }
      #osgStartButton2{
        background-color:rgb(54, 219, 54);
      }
      #osgStartButton2:disabled{
        background-color:rgb(170, 255, 170);
      }
      #osgStartButton2:hover{
        background-color:rgb(48, 194, 48);
      }
    </style>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
      gebi("ytButton").src=window.location.origin+"/musicQuiz/ytLogo.png";

      const socket = io();

      socket.on("connect", () => {
        console.log(`connected with transport ${socket.io.engine.transport.name}`);
        socket.io.engine.on("upgrade", (transport) => {
          console.log(`transport upgraded to ${transport.name}`);
        });
      });

      socket.on("connect_error", (err) => {
        console.log(`connect_error due to ${err.message}`);
      });

      socket.on("disconnect", (reason) => {
        console.log(`disconnect due to ${reason}`);
      });

      var msg = function(msg){
        socket.emit("yo",msg);
      }

      //either: Math.floor(Math.random()*__)+__  Math.floor(Math.random()*__+__) OR (int) at beginning
      var games = document.getElementsByClassName("contentBox");
      for (var i=0;i<games.length;i++){
        games[i]=games[i].id;
      }
      
      var hideAllGames = function(){
        for (var i of games){
          gebi(i).style.display="none";
        }
      }
      /*
      var highlightTab = function(tab){
        for (var i of games){
          gebi(i+"Tab").style.backgroundColor="rgb(243 244 246)";
        }
        gebi(tab+"Tab").style.backgroundColor="rgb(199, 200, 201)";
      }
      */
      window.onload=function(){
        if (window.innerWidth<700){
          //small
          document.getElementById("navItemContainer").style.display="none"
          document.getElementById("menuToggle").addEventListener("click",function(){
            if (navMenuShown) document.getElementById("navItemContainer").style.display="none"
            else document.getElementById("navItemContainer").style.display="";
            navMenuShown=!navMenuShown;
          })
        }
        resize();
        //gebi("tabs").style.left=gebi("contentBox").offsetLeft+"px";
        //gebi("tabs").style.top=(gebi("contentBox").offsetTop-25)+"px";
        //highlightTab(games[0]+"Tab");
        for (var i of games){
          gebi(i+"Tab").addEventListener("click",function(event){
            var eId = event.srcElement.id.substring(0,event.srcElement.id.length-3);
            //highlightTab(eId+"Tab");
            hideAllGames();
            gebi(eId).style.display="";
          })
        }
      }
      var tries = 0;
      var decreaseVisualLife = function(heart){
        setTimeout(function () { gebi("heart"+heart).style.display="none";setTimeout(function () { gebi("heart"+heart).style.display="";setTimeout(function () { gebi("heart"+heart).style.display="none";setTimeout(function () { gebi("heart"+heart).style.display="";setTimeout(function () { gebi("heart"+heart).style.display="none";setTimeout(function () { gebi("heart"+heart).style.display="";setTimeout(function () { gebi("heart"+heart).style.display="none";setTimeout(function () { gebi("heart"+heart).style.display="";setTimeout(function () { gebi("heart"+heart).style.display="none" }, 55)}, 182)}, 55)}, 55)}, 55)}, 55)}, 55)}, 55)}, 55)
        tries++;
      }
      var resetLife = function(){
        gebi("heart1").style.display="";
        gebi("heart2").style.display="";
        gebi("heart3").style.display="";
        tries=0;
      }

      const urlParams = new URLSearchParams(window.location.search);
      var accessToken = urlParams.get("access_token");
      const refreshToken = urlParams.get("refresh_token");
      console.log(accessToken)
      var getRequest = (apiLink, access_token, callback) => {
        var req = new XMLHttpRequest();
        req.open("GET", apiLink);
        if (access_token!==undefined)req.setRequestHeader("Authorization", "Bearer " + access_token);
        req.send();
        req.addEventListener("readystatechange", ()=>{
          if (req.status === 200 && req.readyState === 4) {
            var arr = JSON.parse(req.responseText);
            var type = "";
            callback(undefined, arr); //undefined is basically null which means nothing
          } else if (req.readyState === 4){
            console.log("REEEEEEEEEEe", undefined)
            callback(req.responseText, undefined)
          }
        })
      }
      //load youtube iframe
      
      //This code loads the IFrame Player API code asynchronously.
      var tag = document.createElement('script');

      tag.src = "https://youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
      var player;
      //src: https://stackoverflow.com/questions/1912501/unescape-html-entities-in-javascript/34064434#34064434
      function htmlDecode(input) {
        var doc = new DOMParser().parseFromString(input, "text/html");
        return doc.documentElement.textContent;
      }

      //This function creates an <iframe> (and YouTube player) after the API code downloads.
      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          //videoId would go here
          playerVars: {
            'playsinline': 1
          },
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
        resize();
      }

      function onPlayerReady(){
        player.setVolume(50);//not rip headphones users immediately
      }

      function onPlayerStateChange(){
      }

      var totalPlaylists = [];
      var currYtPlaylists = [];
      var selected = [];
      var createBubble = function(playlist,type){
        var div = document.createElement("div");
        var p = document.createElement("p");
        div.className = "flex justify-center items-center rounded-xl"
        if (type==="ls") div.style.border = "2px solid blue";
        else if (type==="yt") div.style.border = "2px solid red"
        else div.style.border = "2px solid black";
        div.style.height = "50px";
        div.style.outlineOffset="-7px";
        p.style.width="50%";
        p.style.textOverflow="ellipsis";
        p.style.overflow="hidden";
        p.style.whiteSpace="nowrap";
        p.innerHTML=playlist.name;

        div.addEventListener("click",function(){
          //add outline offset -7px
          var alrSelected = false;
          for (var i=0;i<selected.length;i++){
            if (selected[i]===this.children[0].innerHTML){ //ASSUMING THAT THE FIRST CHILD IS THE P ELEMENT!!
              //deselect since it is alr selected
              alrSelected=true;
              selected.splice(i,1);
              this.style.outline="";
            }
          }
          if (!alrSelected){
            //so now select
            selected.push(this.children[0].innerHTML);
            this.style.outline="2px solid black";
          }
        })
        div.appendChild(p);
        gebi("playlistB").appendChild(div);
      }
      function finallyDo(){
        for (var i=0;i<totalPlaylists.length;i++){
          createBubble(totalPlaylists[i],"df")
        }
      }
      getRequest("https://api.spotify.com/v1/me/playlists", accessToken, (dogsErr, theStuffData)=>{ 
        if (dogsErr){
          console.log("dogs err line515");
        }else{
          playlistTotal=theStuffData.total;
          totalPlaylists=[];
          for (var i=0;i<playlistTotal;i++){
            totalPlaylists.push(0);
          }
          var collect = {}
          var things = function(atoms){
            if (atoms<playlistTotal){
              getRequest("https://api.spotify.com/v1/me/playlists"+"?"+"&limit=50"+"&offset="+atoms, accessToken, (playlistFetchErr, playlistData)=>{
                if (playlistFetchErr){
                  console.log("playlistFetchErr: " + playlistFetchErr);
                } else {
                  for (var i=0;i<playlistData.items.length;i++){
                    totalPlaylists[atoms+i]=playlistData.items[i];
                  }
                  things(atoms+50);
                }
              })
            }else{
              finallyDo();
            }
          }
          //put in liked songs first
          totalPlaylists.push({"name":"Liked Songs"});
          createBubble(totalPlaylists[0],"ls");
          things(0);
        }
      })


      function checkListInStorage(list){
        var bad=false;
        if (localStorage.getItem("osgSavedYtPlaylists")===null||localStorage.getItem("osgSavedYtPlaylists")===undefined||localStorage.getItem("osgSavedYtPlaylists")===""||localStorage.getItem("osgSavedYtPlaylists")==="null"){
          var loadedSongs={
            items:[]
          }
          localStorage.setItem("osgSavedYtPlaylists",JSON.stringify(loadedSongs));
          return false;
        }
        var loadedSongs = JSON.parse(localStorage.getItem("osgSavedYtPlaylists"));
        for(var i=0;i<loadedSongs.items.length;i++){
          if (loadedSongs.items[i].title==list.title){
            bad=true;
          }
        }
        return bad;
      }
      var getYtPlaylists = function() {
        currYtPlaylists=[];
        if (localStorage.getItem("osgSavedYtPlaylists")===null||localStorage.getItem("osgSavedYtPlaylists")===undefined||localStorage.getItem("osgSavedYtPlaylists")===""||localStorage.getItem("osgSavedYtPlaylists")==="null"){
          var loadedSongs={
            items:[]
          }
          localStorage.setItem("osgSavedYtPlaylists",JSON.stringify(loadedSongs));
        }
        document.getElementById("ytPlaylists").innerHTML="";
        var playlistData = JSON.parse(localStorage.getItem("osgSavedYtPlaylists"));
        currYtPlaylists = playlistData.items;
        for (var i=0;i<playlistData.items.length;i++){
          createBubble(playlistData.items[i],"yt");
        }
      }
      getYtPlaylists();
      document.getElementById("ytButton").addEventListener("click",function(){
        //first pop up prompt msg asking for yt playlist link
        //then check link validity / playlist validity
        //then save to localstorage
        //then reload using getYtPlaylists()

        //actually load yt playlists in their own div situated above the spotify one

        var retLink = function(){
          var playlistId = prompt("What is the playlist ID or link?\nIf you have the link to the playlist it is the stuff after the ?list= thing :)");


          //USE URL PARAMS TO PARSE LINK IF LINK DETECTED !!!


          if (playlistId===null){
            //cancel
            return null;
          }else if (playlistId.trim()===""){
            alert("pls write something");
            return retLink();
          }else{
            //test validity
            var req = new XMLHttpRequest();
            req.open("GET",
              "https://www.googleapis.com/youtube/v3/playlistItems"
              +"?playlistId="+playlistId
              +"&key="+"AIzaSyC5YeBNQyA8mpjfL4WEdi3DBEwSd9ayxwk"
              +"&part=contentDetails"
              +"&maxResults=1"
            );
            req.send();
            req.addEventListener("readystatechange", ()=>{
              if (req.status === 200 && req.readyState === 4) {
                //init 성공
                var body = JSON.parse(req.responseText);
                if (body.pageInfo.totalResults===0||body.pageInfo.totalResults==="0"){
                  //실패 미안해
                  alert("error: playlist has zero items bruh")
                }else{
                  //완전 성공 우후우우우우우우우우
                  //save to local
                  //first format the save
                  var playlistReq = new XMLHttpRequest();
                  playlistReq.open("GET",
                    "https://www.googleapis.com/youtube/v3/playlists"
                    +"?id="+playlistId
                    +"&key="+"AIzaSyC5YeBNQyA8mpjfL4WEdi3DBEwSd9ayxwk"
                    +"&part=snippet"
                  );
                  playlistReq.send();
                  playlistReq.addEventListener("readystatechange", ()=>{
                    if (playlistReq.status === 200 && playlistReq.readyState === 4) {
                      var thisPlaylistData = JSON.parse(playlistReq.responseText);
                      var thisPlaylist = {
                        id:playlistId,
                        name:thisPlaylistData.items[0].snippet.title
                      }
                      var storedLists = JSON.parse(localStorage.getItem("osgSavedYtPlaylists"));
                      if (localStorage.getItem("osgSavedYtPlaylists")===null||localStorage.getItem("osgSavedYtPlaylists")===undefined||localStorage.getItem("osgSavedYtPlaylists")===""||localStorage.getItem("osgSavedYtPlaylists")==="null"){
                        storedLists={
                          items:[]
                        }
                        storedLists.items.push(thisPlaylist)
                      }else{
                        if (!checkListInStorage(thisPlaylist)){
                          storedLists.items.push(thisPlaylist)
                        }
                      }
                      localStorage.setItem("osgSavedYtPlaylists",JSON.stringify(storedLists));
                      getYtPlaylists();
                    }else if(playlistReq.readyState===4){
                      //idk some fail
                    }
                  })
                }
              } else if (req.readyState === 4){
                //bad
                alert("playlist id was bad. try again or check ur id and make sure you got it right or maybe the playlist is private or something else sryyyyyyyyyy")
              }
            })
          }
        }
        retLink();
      })
    
      var showMenu = function(menu){
        var menus = document.getElementsByClassName("osgStart");
        for (var i of menus){
          if (i.id.substring(4)===menu) i.style.display="";
          else i.style.display="none";
        }
      }
      gebi("osgStartButton1").addEventListener("click",function(){
        showMenu("2");
      })
      gebi("osgBackButton2").addEventListener("click",function(){
        showMenu("1");
      })
      gebi("osgStartButton2").addEventListener("click",function(){
        //start the gameeee
      })
    </script>
  </body>
</html>